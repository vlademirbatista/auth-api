name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
          
      - name: Build with Maven
        run: ./mvnw clean package -DskipTests
        
      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar

      - name: Build Frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: ./target

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./frontend-dist

      - name: Deploy to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "target,frontend-dist"
          target: "/home/ubuntu/deploy_cache"
          
      - name: Configure Production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Debug: List files to verify transfer
            echo "Listing deploy_cache:"
            ls -R /home/ubuntu/deploy_cache

            # 1. Setup Backend
            echo "Deploying Backend..."
            mkdir -p /home/ubuntu/app
            mv /home/ubuntu/deploy_cache/target/*.jar /home/ubuntu/app/auth-api.jar
            sudo systemctl restart auth-api || echo "Service not configured yet"

            # 2. Setup Frontend (Nginx serving static files)
            echo "Deploying Frontend..."
            sudo mkdir -p /var/www/html
            # Clean old files to avoid conflicts
            sudo rm -rf /var/www/html/*
            
            # Copy contents. Note: based on SCP, it might be in frontend-dist folder
            if [ -d "/home/ubuntu/deploy_cache/frontend-dist" ]; then
              sudo cp -r /home/ubuntu/deploy_cache/frontend-dist/* /var/www/html/
            else
              # Fallback if scp flattened it
              sudo cp -r /home/ubuntu/deploy_cache/* /var/www/html/ 2>/dev/null || true
              # Remove jar from www if it got there
              sudo rm -f /var/www/html/*.jar
            fi
            
            # Fallback Check
            if [ ! -f /var/www/html/index.html ]; then
              echo "<h1>Debug: React files missed. Copy failed.</h1>" | sudo tee /var/www/html/index.html
              echo "Listing deploy_cache (debug):"
              ls -R /home/ubuntu/deploy_cache
            fi
            
            # Fix Permissions (Standard Web)
            sudo chown -R www-data:www-data /var/www/html
            sudo find /var/www/html -type d -exec chmod 755 {} \;
            sudo find /var/www/html -type f -exec chmod 644 {} \;
            
            # 3. Configure Nginx (Full Overwrite to avoid conflicts)
            echo "Configuring Nginx..."
            sudo bash -c 'cat <<EOF > /etc/nginx/sites-available/default
            server {
                listen 80 default_server;
                listen [::]:80 default_server;

                root /var/www/html;
                index index.html index.htm index.nginx-debian.html;

                server_name _;

                # Serve React Frontend
                location / {
                    try_files \$uri \$uri/ /index.html;
                }

                # Proxy API to Spring Boot
                location /api/ {
                    proxy_pass http://localhost:8080;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }
            }
            EOF'

            # 4. Clean up and Restart
            rm -rf /home/ubuntu/deploy_cache
            sudo nginx -t && sudo systemctl restart nginx
            echo "Deployment Complete!"
